# 一、HDFS的写数据流程

---

## 1、服务端启动HDFS中的NameNode(NN)和DataNode(DN)进程
## 2、客户端创建一个分布式文件系统的客户端，由该客户端向NN发送请求，请求上传文件。
## 3、NN处理请求，检查客户端是否有上传文件的权限、上传路径是否合法等。
## 4、若检查通过，NN响应客户端，可以上传文件
## 5、客户端根据设置的块(Block)大小开始上传第一个块。
* NN根据客户端上传文件的副本数量，通过机架感应策略选取指定数量的DN节点返回给客户端，用来存储上传的文件
## 6、客户端根据返回的DN节点，请求与第一个DN节点建立传输通道，并由这个DN节点依次向通道中的(距离当前DN节点最近的节点)下一个节点发送建立传输通道的请求，各个节点发送响应，通道建立完毕。
## 7、客户端每读取64K的数据，封装成一个packet(数据包，文件传输的基本单位)，并将packet发送到通道的下一个节点，通道中的节点在收取到packet之后，进行落盘存储，并进行检验，之后将该packet发送到通道的下一个节点。
* 每个packet由若干chunk(小块)组成，一个小块由512B的数据和4B的校验和组成
## 8、一个块的数据传输完成之后，通道关闭，DN向NN上报消息，已经接收到某个块
## 9、第一个块传输完成，第二个块开始传输，依次重复5-8，直至最后一个块传输完成，NN向客户端响应传输完成，客户端关闭输出流。

---

# 二、异常的写流程
---
## 前六个步骤同正常的写数据流程
## 7 、客户端每读取64KB的数据，封装为一个packet，并放入一个称为dataQuene(待发送)的队列中，发送时，将dataquene中的packet按顺序依次放入到ackquene(正在发送队列)，由ackquene发送到传输通道中的第一个DN节点。每个节点在收到packket之后，向客户端发送ack确认消息。**如果一个packet在发送之后，已经收到了所有DN节点返回的ack确认消息，这个packet会在ackquene中删除，假如在接收DN返回的ack确认消息是发生了超时，传输中止，ackquene重的packet会回滚到dataquene中**
## 8、客户端重新请求建立新的传输通道，剔除损坏的DN节点。建立完成后，继续传输文件。
* 只要有一个DN节点接收到了数据，并上报NN节点已经完成接收此数据块，NN就会认为当前块已经传输成功。**NN会自动维护设定的文件副本数量**
---
# 三、机架感知策略
## 1、网络拓扑-节点距离计算
### 节点距离：两个节点到达最近的共同祖先的距离总和
* 是一种抽象距离
## 2、机架感知
### 待续